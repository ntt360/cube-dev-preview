<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>preview@cube</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- 添加预览组件css -->
  <link rel="stylesheet" href="https://s0.ssl.qhres2.com/static/8d72b25369122bfd.css">
  <base target="_blank">
  <style>
    #tips {display: none; text-align: center; font-size: 18px; line-height: 1.5;}
    .error-tips {text-align: center;margin:40px 0;color:#f60;font-size: 14px;}
    @media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {
      #tips{display: block}
    }
  </style>
  <!--[if IE]>
    <style>
      #tips{display: block}
    </style>
  <![endif]-->
</head>
<body>
  <div id="tips">暂不支持 IE 浏览器 <br> 推荐使用 Chrome 浏览器</div>
  <div id="cube-doc"></div>
  <!-- 添加预览组件js -->
  <script type="module" src="https://s0.ssl.qhres2.com/static/b3a64a58cbb0a10e.js"></script>
  <script>
    /* 默认加载的sdk */
    const defaultLibFiles = {
      css: 'https://s0.ssl.qhres2.com/static/a9d4024a8f92746a.css#cubesdk.2.0.0',
      js: 'https://s0.ssl.qhres2.com/static/5df9d068e78511c3.js#cubesdk.2.0.0'
    };

    function loadJs(url){
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        document.body.appendChild(script);
        script.onload = function(){
          resolve()
        }
        script.onerror = function(){
          reject()
        }
      })
    }
    function loadCss(url){
      return new Promise((resolve, reject) => {
        const style = document.createElement('link');
        style.setAttribute('rel', 'stylesheet');
        style.href = url;
        document.head.appendChild(style);
        style.onload = function(){
          resolve()
        }
        style.onerror = function(){
          reject()
        }
      })
    }
    /* load cube res 文件*/
    function loadRes(res){
      const { origin } = location;
      return loadJs(`${origin}/${res}`);
    }

    /* 加载指定版本 sdk 到页面 */
    function loadLib(version){
      return new Promise((resolve, reject) => {
        const cbName = 'cb' + Date.now();
        window[cbName] = function(resp){
          if(!resp || resp.errno !== 0){
            reject('get version data error.');
          } else {
            const libFiles = resp?.data?.data[version];
            if(libFiles){
              resolve(libFiles);
            } else {
              resolve(defaultLibFiles);
            }
          }
        }
        loadJs(`https://api.dhrest.com/dataconfapi?uniqid=VSoIiRrYjDHFlHaX&callback=${cbName}`).catch(e => {
          resolve(defaultLibFiles);
        })
      }).then(files => {
        const {js, css} = files;
        return Promise.all([loadJs(js), loadCss(css)]);
      });
    }

    async function getCubeInfo(){
      const id = new URLSearchParams(window.location.search).get('id');
      if(!/^\w{32}$/.test(id)){
        throw new Error('请指定合法的预览 id。');
      }
      const resp = await fetch('/get_info?id=' + id);
      if(!resp.ok){
        throw new Error('获取 cube 信息失败：网络错误。');
      }
      const body = await resp.json();
      if(!body || body.errno !== 0){
        throw new Error(body.msg || '获取 cube 信息失败：服务器错误。');
      }
      return body.data
    }

    async function renderCube (selector){
      let data = await getCubeInfo()

      /* 加载sdk */
      await loadLib(data.lib_version)

      /* 实例化 cube */
      const { init, Cool } = CubeSdk;
      const sysData = {
        cityCode: '101010100',
        mp360Support: true,
        webpSupport: {'lossy':true,'lossless':true,'alpha':true,'animation':true},
        userAgent: 'CUBETOOL ' + navigator.userAgent,
        where: 'dev_preview',
        debug: true
      };
      init(sysData);
      let res = data.res
      delete data.res

      const ctl = document.getElementById('wrap-width');
      let cool = new Cool({data, width: ctl.value});

      if (res) {
        await loadJs(res)
      }

      cool.insert(selector, 'top');
      cool.trigger('show');
      cool.trigger('completeshow');

      ctl.addEventListener('change', e => {
        cool.trigger('resize', {width: ctl.value});
      })

      return cool
    }
  </script>
</body>
</html>
